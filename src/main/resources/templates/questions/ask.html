<!DOCTYPE html>
<html lang="en" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Ask a Question</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Header -->
    <div class="mb-4">
        <h1 class="h2 mb-2">
            <i class="bi bi-question-circle-fill text-primary"></i> Ask a Public Question
        </h1>
        <p class="text-muted mb-0">
            Get help from millions of developers around the world
        </p>
    </div>

    <!-- Guidelines Card -->
    <div class="card bg-light mb-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-lightbulb text-warning"></i> Writing a good question
            </h5>
            <p class="card-text mb-2">You're ready to ask a programming-related question and this form will help guide you through the process.</p>
            <div class="small">
                <strong>Steps:</strong>
                <ul class="mb-0">
                    <li>Summarize your problem in a one-line title</li>
                    <li>Describe your problem in more detail</li>
                    <li>Describe what you tried and what you expected to happen</li>
                    <li>Add tags which help surface your question to members of the community</li>
                    <li>Review your question and post it to the site</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Ask Question Form -->
    <form th:action="@{/questions/ask}" method="post" id="askQuestionForm">
        <!-- Title -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-pencil"></i> Title
                </h5>
            </div>
            <div class="card-body">
                <label for="title" class="form-label">
                    Be specific and imagine you're asking a question to another person
                </label>
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="title" 
                       name="title" 
                       placeholder="e.g. How do I fix NullPointerException in Java Spring Boot?"
                       required 
                       minlength="15"
                       maxlength="200">
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> Minimum 15 characters, maximum 200 characters
                </div>
                <div class="invalid-feedback">
                    Title must be at least 15 characters.
                </div>
            </div>
        </div>

        <!-- Body -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-file-text"></i> Body
                </h5>
            </div>
            <div class="card-body">
                <label for="body" class="form-label">
                    Include all the information someone would need to answer your question
                </label>
                
                <!-- Markdown Toolbar -->
                <div class="btn-toolbar mb-2 border-bottom pb-2" role="toolbar">
                    <div class="btn-group btn-group-sm me-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**')" title="Bold">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*')" title="Italic">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('`', '`')" title="Code">
                            <i class="bi bi-code"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm me-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n```\n', '\n```\n')" title="Code Block">
                            <i class="bi bi-code-square"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](url)')" title="Link">
                            <i class="bi bi-link"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n- ', '')" title="Bullet List">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n1. ', '')" title="Numbered List">
                            <i class="bi bi-list-ol"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n> ', '')" title="Quote">
                            <i class="bi bi-quote"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n## ', '')" title="Heading">
                            <i class="bi bi-type-h2"></i>
                        </button>
                    </div>
                </div>

                <textarea class="form-control" 
                          id="body" 
                          name="body" 
                          rows="12"
                          required></textarea>

                <!-- Image Upload Section -->
                <div class="mt-3">
                    <label for="images" class="form-label">
                        <i class="bi bi-image"></i> Add Images
                    </label>
                    <input type="file" 
                           class="form-control" 
                           id="images" 
                           name="images" 
                           multiple 
                           accept="image/*"
                           onchange="previewImages(event)">
                    <div id="imagePreviewContainer" class="d-flex flex-wrap gap-2 mt-2"></div>
                </div>

                <!-- Group Selection -->
                <div class="mt-3" th:if="${not #lists.isEmpty(userGroups)}">
                    <label for="groupId" class="form-label">
                        <i class="bi bi-people"></i> Post in Group (Optional)
                    </label>
                    <select class="form-select" id="groupId" name="groupId">
                        <option value="">Post Publicly</option>
                        <option th:each="group : ${userGroups}" 
                                th:value="${group.id}" 
                                th:text="${group.name}">Group Name</option>
                    </select>
                </div>

                <div class="form-text">
                    <i class="bi bi-markdown"></i> Markdown formatting supported
                </div>
            </div>
        </div>

        <!-- Tags -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-tags"></i> Tags
                </h5>
            </div>
            <div class="card-body">
                <label for="tags" class="form-label">
                    Add up to 5 tags to describe what your question is about
                </label>
                <input type="text" 
                       class="form-control" 
                       id="tags" 
                       name="tags" 
                       placeholder="e.g. java spring-boot mysql database"
                       required>
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> Separate tags with spaces. At least 1 tag required, maximum 5 tags.
                </div>
                
                <!-- Popular Tags Suggestions -->
                <div class="mt-3">
                    <small class="text-muted d-block mb-2">Popular tags:</small>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="tag-badge" onclick="addTag('java')">java</button>
                        <button type="button" class="tag-badge" onclick="addTag('javascript')">javascript</button>
                        <button type="button" class="tag-badge" onclick="addTag('python')">python</button>
                        <button type="button" class="tag-badge" onclick="addTag('spring-boot')">spring-boot</button>
                        <button type="button" class="tag-badge" onclick="addTag('react')">react</button>
                        <button type="button" class="tag-badge" onclick="addTag('sql')">sql</button>
                        <button type="button" class="tag-badge" onclick="addTag('database')">database</button>
                        <button type="button" class="tag-badge" onclick="addTag('html')">html</button>
                        <button type="button" class="tag-badge" onclick="addTag('css')">css</button>
                        <button type="button" class="tag-badge" onclick="addTag('nodejs')">nodejs</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-4">
            <div class="card-body bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send"></i> Post Your Question
                        </button>
                        <a th:href="@{/}" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsCheck" required>
                        <label class="form-check-label small" for="termsCheck">
                            I agree to the <a href="#">terms of service</a> and <a href="#">code of conduct</a>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Tips Sidebar -->
    <div class="card border-primary mb-4">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <i class="bi bi-lightbulb"></i> Tips for Asking Great Questions
            </h6>
        </div>
        <div class="card-body">
            <ul class="small mb-0">
                <li class="mb-2"><strong>Search first:</strong> Make sure your question hasn't been asked before</li>
                <li class="mb-2"><strong>Be clear:</strong> Use a title that summarizes the specific problem</li>
                <li class="mb-2"><strong>Be specific:</strong> Include details like error messages, what you've tried</li>
                <li class="mb-2"><strong>Show code:</strong> Include minimal, reproducible example code</li>
                <li class="mb-2"><strong>Format properly:</strong> Use code blocks for code, proper grammar</li>
                <li class="mb-2"><strong>Tag wisely:</strong> Use relevant tags to help others find your question</li>
                <li class="mb-0"><strong>Be respectful:</strong> Remember there's a human on the other side</li>
            </ul>
        </div>
    </div>

    <!-- Markdown Help Modal -->
    <div class="modal fade" id="markdownHelpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-markdown"></i> Markdown Formatting Guide
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>You type</th>
                                <th>You get</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>**bold text**</code></td>
                                <td><strong>bold text</strong></td>
                            </tr>
                            <tr>
                                <td><code>*italic text*</code></td>
                                <td><em>italic text</em></td>
                            </tr>
                            <tr>
                                <td><code>`code`</code></td>
                                <td><code>code</code></td>
                            </tr>
                            <tr>
                                <td><code>```<br>code block<br>```</code></td>
                                <td><pre>code block</pre></td>
                            </tr>
                            <tr>
                                <td><code>[link](http://url)</code></td>
                                <td><a href="#">link</a></td>
                            </tr>
                            <tr>
                                <td><code>- list item</code></td>
                                <td>• list item</td>
                            </tr>
                            <tr>
                                <td><code>> quote</code></td>
                                <td><blockquote>quote</blockquote></td>
                            </tr>
                            <tr>
                                <td><code>## Heading</code></td>
                                <td><h2>Heading</h2></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-scripts">
<script>
// Markdown toolbar functions
function insertMarkdown(before, after) {
    const textarea = document.getElementById('body');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selected = text.substring(start, end);
    
    const newText = text.substring(0, start) + before + selected + after + text.substring(end);
    textarea.value = newText;
    
    // Set cursor position
    const newCursorPos = start + before.length + selected.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

// Add tag function
function addTag(tag) {
    const tagsInput = document.getElementById('tags');
    const currentTags = tagsInput.value.trim();
    const tagsArray = currentTags ? currentTags.split(' ') : [];
    
    if (!tagsArray.includes(tag) && tagsArray.length < 5) {
        tagsArray.push(tag);
        tagsInput.value = tagsArray.join(' ');
    }
}

// Preview toggle
function togglePreview() {
    const preview = document.getElementById('preview');
    const body = document.getElementById('body').value;
    const previewContent = document.getElementById('previewContent');
    
    if (preview.style.display === 'none') {
        // Simple markdown to HTML conversion (basic)
        let html = body
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*|_(.+?)_/g, '<em>$1$2</em>')
            .replace(/`(.+?)`/g, '<code>$1</code>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/\n/g, '<br>');
        
        previewContent.innerHTML = html;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Form validation
document.getElementById('askQuestionForm').addEventListener('submit', function(event) {
    const title = document.getElementById('title').value;
    const body = document.getElementById('body').value;
    const tags = document.getElementById('tags').value.trim();
    
    let isValid = true;
    let errorMessage = '';
    
    if (title.length < 15) {
        errorMessage += '- Title must be at least 15 characters\n';
        isValid = false;
    }
    
    if (body.length < 30) {
        errorMessage += '- Body must be at least 30 characters\n';
        isValid = false;
    }
    
    const tagsArray = tags.split(' ').filter(t => t.length > 0);
    if (tagsArray.length === 0) {
        errorMessage += '- At least 1 tag is required\n';
        isValid = false;
    } else if (tagsArray.length > 5) {
        errorMessage += '- Maximum 5 tags allowed\n';
        isValid = false;
    }
    
    if (!document.getElementById('termsCheck').checked) {
        errorMessage += '- You must agree to the terms of service\n';
        isValid = false;
    }
    
    if (!isValid) {
        event.preventDefault();
        alert('Please fix the following errors:\n\n' + errorMessage);
    }
});

// Auto-save to localStorage
const title = document.getElementById('title');
const body = document.getElementById('body');
const tags = document.getElementById('tags');

[title, body, tags].forEach(element => {
    // Load saved data
    const saved = localStorage.getItem('ask_' + element.id);
    if (saved && element.value === '') {
        element.value = saved;
    }
    
    // Save on input
    element.addEventListener('input', function() {
        localStorage.setItem('ask_' + element.id, element.value);
    });
});

// Clear localStorage on successful submit
document.getElementById('askQuestionForm').addEventListener('submit', function() {
    localStorage.removeItem('ask_title');
    localStorage.removeItem('ask_body');
    localStorage.removeItem('ask_tags');
});

// Character counter
title.addEventListener('input', function() {
    const count = this.value.length;
    const color = count < 15 ? 'text-danger' : (count > 180 ? 'text-warning' : 'text-success');
    // You can add a character counter if needed
});

// Image preview function
function previewImages(event) {
    const container = document.getElementById('imagePreviewContainer');
    container.innerHTML = ''; // Clear previous previews
    
    Array.from(event.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('img-thumbnail', 'me-2');
            img.style.width = '100px'; // Set a fixed width for thumbnails
            img.style.height = 'auto';
            
            container.appendChild(img);
        }
        reader.readAsDataURL(file);
    });
}
</script>
</th:block>
</body>
</html>