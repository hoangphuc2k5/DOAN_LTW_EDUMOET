<!DOCTYPE html>
<html lang="en" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${pageTitle}">Ask Question</title>
    <style>
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-preview-item {
            position: relative;
            display: inline-block;
        }
        .remove-image {
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border-radius: 50%;
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1 class="mb-4">Ask a Question</h1>
    
    <div class="card">
        <div class="card-body">
            <form th:action="@{/questions/ask}" th:object="${question}" method="post" enctype="multipart/form-data">
                <div class="mb-3">
                    <label for="title" class="form-label">Title</label>
                    <input type="text" class="form-control" th:field="*{title}" id="title" 
                           required minlength="15" maxlength="200"
                           placeholder="What's your programming question? Be specific.">
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('title')}" th:errors="*{title}"></div>
                </div>
                
                <div class="mb-3">
                    <label for="body" class="form-label">Body</label>
                    <textarea class="form-control" th:field="*{body}" id="body" rows="15" required
                              placeholder="Include all the information someone would need to answer your question"></textarea>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('body')}" th:errors="*{body}"></div>
                </div>

                <!-- Image Upload Section -->
                <div class="mb-3">
                    <label for="files" class="form-label">Add Images</label>
                    <input type="file" class="form-control" id="files" name="files" 
                           multiple accept="image/*" onchange="previewImages(event)">
                    <small class="form-text text-muted">
                        You can add multiple images (max 5MB each). Supported formats: JPG, PNG, GIF
                    </small>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('images')}" th:errors="*{images}"></div>
                    <div id="imagePreviewContainer" class="image-preview-container"></div>
                </div>
                
                <div class="mb-3">
                    <label for="tagString" class="form-label">Tags</label>
                    <input type="text" class="form-control" th:field="*{tagString}" id="tagString" required
                           placeholder="e.g., java, spring-boot, javascript">
                    <small class="form-text text-muted">
                        Add up to 5 tags separated by commas (e.g., java, spring, hibernate)
                    </small>
                    <div class="invalid-feedback" th:if="${#fields.hasErrors('tags')}" th:errors="*{tags}"></div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> Post Your Question
                    </button>
                    <a th:href="@{/}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
<script>
function previewImages(event) {
    const container = document.getElementById('imagePreviewContainer');
    container.innerHTML = '';
    const files = event.target.files;
    
    if (files) {
        Array.from(files).forEach((file, index) => {
            if (file.size > 5 * 1024 * 1024) {
                alert(`File ${file.name} is too large. Maximum size is 5MB`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'image-preview-item';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-preview';
                
                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = function() {
                    div.remove();
                    // Clear the file input if all previews are removed
                    if (container.children.length === 0) {
                        document.getElementById('files').value = '';
                    }
                };
                
                div.appendChild(img);
                div.appendChild(removeBtn);
                container.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }
}
</script>
</th:block>
</body>
</html>